apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-initdb-config
  namespace: postgres
data:
  init.sql: |
    -- Create dimension tables for star schema
    CREATE TABLE IF NOT EXISTS dim_date (
        date_id SERIAL PRIMARY KEY,
        date_value DATE NOT NULL,
        year INT NOT NULL,
        month INT NOT NULL,
        day INT NOT NULL,
        quarter INT NOT NULL,
        day_of_week INT NOT NULL
    );
    
    CREATE TABLE IF NOT EXISTS dim_customer (
        customer_id SERIAL PRIMARY KEY,
        customer_name VARCHAR(255) NOT NULL,
        email VARCHAR(255),
        address TEXT,
        city VARCHAR(100),
        country VARCHAR(100)
    );
    
    CREATE TABLE IF NOT EXISTS dim_product (
        product_id SERIAL PRIMARY KEY,
        product_name VARCHAR(255) NOT NULL,
        product_category VARCHAR(100),
        product_price DECIMAL(10, 2),
        supplier VARCHAR(255)
    );
    
    CREATE TABLE IF NOT EXISTS dim_location (
        location_id SERIAL PRIMARY KEY,
        location_name VARCHAR(255),
        city VARCHAR(100),
        state VARCHAR(100),
        country VARCHAR(100),
        postal_code VARCHAR(20)
    );
    
    -- Create fact table
    CREATE TABLE IF NOT EXISTS fact_sales (
        sale_id SERIAL PRIMARY KEY,
        date_id INT REFERENCES dim_date(date_id),
        customer_id INT REFERENCES dim_customer(customer_id),
        product_id INT REFERENCES dim_product(product_id),
        location_id INT REFERENCES dim_location(location_id),
        quantity INT NOT NULL,
        unit_price DECIMAL(10, 2) NOT NULL,
        total_amount DECIMAL(12, 2) NOT NULL,
        discount DECIMAL(10, 2) DEFAULT 0,
        tax_amount DECIMAL(12, 2) DEFAULT 0
    );
    
    -- Create views/datamarts for clients
    CREATE VIEW sales_summary AS
    SELECT 
        dd.date_value,
        dc.customer_name,
        dp.product_name,
        dl.location_name,
        fs.quantity,
        fs.total_amount
    FROM fact_sales fs
    JOIN dim_date dd ON fs.date_id = dd.date_id
    JOIN dim_customer dc ON fs.customer_id = dc.customer_id
    JOIN dim_product dp ON fs.product_id = dp.product_id
    JOIN dim_location dl ON fs.location_id = dl.location_id;
    
    -- Create read-only user for Power BI/Tableau clients
    DO
    $$
    BEGIN
       IF NOT EXISTS (
          SELECT FROM pg_catalog.pg_user
          WHERE usename = 'client_reader') THEN
          CREATE USER client_reader WITH PASSWORD 'reader_pass123';
       END IF;
    END
    $$;
    
    GRANT CONNECT ON DATABASE datalakehouse TO client_reader;
    GRANT USAGE ON SCHEMA public TO client_reader;
    GRANT SELECT ON ALL TABLES IN SCHEMA public TO client_reader;
    GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO client_reader;